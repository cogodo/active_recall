<!DOCTYPE html>
<html>

<head>
    <title>Active Recall Study Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- Socket.IO client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js"></script>
    <!-- Cartesia JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@cartesia/cartesia-js/dist/index.min.js"></script>
    <script>
        // Check if Cartesia SDK loaded properly
        window.addEventListener('load', function () {
            console.log("Page loaded, checking Cartesia SDK...");
            if (typeof Cartesia === 'undefined') {
                console.error("ERROR: Cartesia SDK failed to load. TTS functionality will not work.");
            } else {
                console.log("Cartesia SDK loaded successfully:", Cartesia);

                // Add a function to test listing voices
                window.listCartesiaVoices = async function () {
                    try {
                        console.log("Attempting to list Cartesia voices...");
                        // First get the Cartesia client
                        const response = await fetch('/get-cartesia-key');
                        const data = await response.json();

                        if (!data.available) {
                            console.warn("Cartesia API key not available");
                            return null;
                        }

                        // Create a client just for this test
                        const client = new Cartesia.Client({
                            apiKey: data.key,
                            cartesiaVersion: "2025-04-16"
                        });

                        // List all available voices
                        console.log("Fetching voice list...");
                        const voices = await client.voices.list();
                        console.log("Available Cartesia voices:", voices);
                        return voices;
                    } catch (error) {
                        console.error("Error listing Cartesia voices:", error);
                        return null;
                    }
                };

                console.log("Voice listing function added. Use window.listCartesiaVoices() in console to test");
            }
        });
    </script>
</head>

<body>
    <h1>Active Recall Study Assistant</h1>

    <div class="instructions">
        <h3>How to use this assistant:</h3>
        <p>1. Tell me what topic you want to review (e.g., "I want to review photosynthesis" or "Help me practice
            JavaScript closures")</p>
        <p>2. I'll generate active recall questions about your topic</p>
        <p>3. Try to answer each question to test your knowledge</p>
        <p>4. Get feedback or ask for hints if you're stuck</p>
        <p>5. Change topics anytime by saying "I want to review [new topic]"</p>

        <h3>Voice Commands:</h3>
        <p>â€¢ Click the ðŸŽ¤ microphone button to enter voice conversation mode (powered by Whisper)</p>
        <p>â€¢ <strong>Browser will ask for microphone permission</strong> - you must allow this to use voice features</p>
        <p>â€¢ Voice levels will be displayed to show when you're speaking</p>
        <p>â€¢ In voice conversation mode, just speak naturally - pauses are detected automatically</p>
        <p>â€¢ Say "hint" or "help" to get assistance with the current question</p>
        <p>â€¢ Say "next question" or "next" to move to the next question</p>
        <p>â€¢ Say "repeat" or "say again" to have the last response repeated</p>
        <p>â€¢ Say "stop listening" to exit voice conversation mode</p>
        <p>â€¢ Say "clear chat" to start a fresh conversation</p>
        <p>â€¢ Toggle "Auto-read responses" to hear all assistant responses with Cartesia TTS</p>
        <p class="security-note">â€¢ This app runs on <strong>localhost</strong> for safe testing</p>
    </div>

    <div class="chat-container">
        <div class="chat-area">
            <div id="chat-messages" class="chat-messages"></div>
            <div id="typing-indicator" class="typing-indicator">Assistant is typing...</div>
            <div class="chat-input">
                <input type="text" id="user-input" placeholder="Ask Spaced">
                <button id="send-button">Send</button>
                <div class="voice-controls">
                    <button id="mic-button" class="mic-button" title="Click to toggle voice conversation mode">
                        <i>ðŸŽ¤</i>
                    </button>
                </div>
                <div id="listening-indicator" class="listening-indicator">Listening...</div>
            </div>
            <div class="voice-toggle">
                <input type="checkbox" id="voice-mode" name="voice-mode">
                <label for="voice-mode">Auto-read responses (Cartesia)</label>
            </div>
        </div>
        <div class="question-area">
            <h2>Study Questions</h2>
            <p>After you specify a topic, active recall questions will appear here.</p>
            <div id="questions-list"></div>
        </div>
    </div>

    <div id="error-message" class="error"></div>

    <div id="continuous-indicator" class="continuous-mode-indicator">Voice Conversation Mode Active (OpenAI Whisper API)
    </div>

    <!-- Audio visualizer for showing speech levels -->
    <div id="audio-visualizer" class="audio-visualizer">
        <div id="visualizer-bars" class="visualizer-bars">
            <!-- Bars will be dynamically created -->
        </div>
        <div class="recording-indicator">
            <div class="recording-dot"></div>
            <div class="recording-label">Listening with OpenAI Whisper...</div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>

</html>